# DSL Schema æ›´æ–°æ€»ç»“

## ğŸ¯ æ›´æ–°å†…å®¹

æ›´æ–°äº† DSL éªŒè¯ç³»ç»Ÿï¼Œä½¿ç”¨ **JSON Schema** + **ä¸¤æ¡é“å¾‹** çš„åˆ†å±‚éªŒè¯æ¶æ„ã€‚

---

## ğŸ“ æ–°å¢/æ›´æ–°æ–‡ä»¶

### 1. `app/models/dsl_schema.json` âœ… æ–°å¢

**æ ‡å‡† JSON Schema å®šä¹‰**ï¼Œç¬¦åˆ Draft-07 è§„èŒƒã€‚

**ç‰¹æ€§**:
- âœ… å®Œæ•´çš„ç±»å‹å®šä¹‰
- âœ… å¿…éœ€å­—æ®µéªŒè¯
- âœ… æšä¸¾å€¼çº¦æŸ
- âœ… æ ¼å¼éªŒè¯ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- âœ… æ•°å€¼èŒƒå›´é™åˆ¶
- âœ… æ•°ç»„é•¿åº¦é™åˆ¶

**å…³é”®çº¦æŸ**:
```json
{
  "trim_frames": {
    "type": "array",
    "items": { "type": "integer", "minimum": 0 },
    "minItems": 2,
    "maxItems": 2
  },
  "overlay_text": {
    "type": "string",
    "maxLength": 10
  },
  "broll": {
    "type": "array",
    "items": { "type": "string" },
    "default": []
  }
}
```

---

### 2. `app/models/dsl_validator.py` âœ… æ–°å¢

**ç‹¬ç«‹çš„éªŒè¯å™¨æ¨¡å—**ï¼ŒåŒ…å«ä¸‰å±‚éªŒè¯ï¼š

#### ç¬¬ 1 å±‚: JSON Schema éªŒè¯
```python
DSLValidator.validate_schema(dsl)
```
- éªŒè¯æ ¼å¼å’Œç±»å‹
- éªŒè¯å¿…éœ€å­—æ®µ
- éªŒè¯æšä¸¾å€¼
- éªŒè¯æ•°å€¼èŒƒå›´

#### ç¬¬ 2 å±‚: ä¸¤æ¡é“å¾‹éªŒè¯
```python
DSLValidator.validate_dsl_against_scenes(dsl, scenes_data, broll_library)
```

**é“å¾‹ 1**: ä¸å…è®¸"æœªæä¾›ç´ æåº“å´è¦æ±‚ç´ æè°ƒç”¨"
- æ£€æŸ¥ `broll` å­—æ®µ
- å¦‚æœæ²¡æœ‰ç´ æåº“ï¼Œ`broll` å¿…é¡»ä¸ºç©º

**é“å¾‹ 2**: åæ ‡ä½“ç³»ç»Ÿä¸€ - å†…éƒ¨åªç”¨ frame
- æ£€æŸ¥ `trim_frames` å¿…é¡»æ˜¯æ•´æ•°
- æ£€æŸ¥ `scenes.json` å¿…é¡»åŒ…å« `fps`

#### ç¬¬ 3 å±‚: ä¸šåŠ¡è§„åˆ™éªŒè¯
- `scene_id` å­˜åœ¨æ€§æ£€æŸ¥
- `trim_frames` èŒƒå›´æ£€æŸ¥
- `trim_frames` é¡ºåºæ£€æŸ¥

---

### 3. `app/models/schemas.py` âœ… æ›´æ–°

**å¯¼å…¥æ–°çš„éªŒè¯å™¨**:
```python
from .dsl_validator import DSLValidator
```

ä¿æŒå‘åå…¼å®¹ï¼Œæ—§ä»£ç æ— éœ€ä¿®æ”¹ã€‚

---

### 4. `test_dsl_schema.py` âœ… æ–°å¢

**å®Œæ•´çš„æµ‹è¯•å¥—ä»¶**ï¼ŒåŒ…å« 7 ä¸ªæµ‹è¯•ï¼š

1. âœ… æœ‰æ•ˆçš„ DSL
2. âœ… ç¼ºå°‘å¿…éœ€å­—æ®µ
3. âœ… ç±»å‹é”™è¯¯
4. âœ… é“å¾‹ 1 è¿å
5. âœ… é“å¾‹ 2 è¿å
6. âœ… å®Œæ•´éªŒè¯æµç¨‹
7. âœ… ç¤ºä¾‹æ–‡ä»¶éªŒè¯

**æµ‹è¯•ç»“æœ**: 7/7 é€šè¿‡ âœ…

---

## ğŸ” éªŒè¯æµç¨‹

### å®Œæ•´éªŒè¯æµç¨‹

```python
from app.models.dsl_validator import DSLValidator

# å®Œæ•´éªŒè¯ï¼ˆä¸‰å±‚ï¼‰
errors = DSLValidator.validate_dsl_against_scenes(
    dsl=dsl_data,
    scenes_data=scenes_data,
    broll_library=None  # å¯é€‰
)

if errors:
    print("éªŒè¯å¤±è´¥:")
    for err in errors:
        print(f"  - {err}")
else:
    print("éªŒè¯é€šè¿‡")
```

### ä»… Schema éªŒè¯

```python
# ä»…éªŒè¯æ ¼å¼å’Œç±»å‹
errors = DSLValidator.validate_schema(dsl_data)
```

---

## ğŸ“Š éªŒè¯å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 1 å±‚: JSON Schema éªŒè¯                                    â”‚
â”‚ - æ ¼å¼å’Œç±»å‹æ£€æŸ¥                                             â”‚
â”‚ - å¿…éœ€å­—æ®µæ£€æŸ¥                                               â”‚
â”‚ - æšä¸¾å€¼æ£€æŸ¥                                                 â”‚
â”‚ - æ•°å€¼èŒƒå›´æ£€æŸ¥                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 2 å±‚: ä¸¤æ¡é“å¾‹éªŒè¯                                        â”‚
â”‚ - é“å¾‹ 1: ç´ æåº“æ£€æŸ¥                                         â”‚
â”‚ - é“å¾‹ 2: åæ ‡ä½“ç³»æ£€æŸ¥                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 3 å±‚: ä¸šåŠ¡è§„åˆ™éªŒè¯                                        â”‚
â”‚ - scene_id å­˜åœ¨æ€§                                           â”‚
â”‚ - trim_frames èŒƒå›´                                          â”‚
â”‚ - trim_frames é¡ºåº                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. æ—©æœŸé”™è¯¯æ£€æµ‹

**JSON Schema åœ¨ç¬¬ä¸€å±‚å°±æ•è·å¤§éƒ¨åˆ†é”™è¯¯**:
- ç±»å‹é”™è¯¯ï¼ˆå­—ç¬¦ä¸² vs æ•´æ•°ï¼‰
- ç¼ºå°‘å¿…éœ€å­—æ®µ
- æ— æ•ˆçš„æšä¸¾å€¼
- è¶…å‡ºèŒƒå›´çš„æ•°å€¼

**ç¤ºä¾‹**:
```json
{
  "trim_frames": ["00:00:01:00", "00:00:04:00"]  // âŒ å­—ç¬¦ä¸²
}
```

**é”™è¯¯ä¿¡æ¯**:
```
Schema éªŒè¯å¤±è´¥: '00:00:01:00' is not of type 'integer'
ä½ç½®: editing_plan.timeline.0.trim_frames.0
```

### 2. æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

**åˆ†å±‚éªŒè¯æä¾›ç²¾ç¡®çš„é”™è¯¯å®šä½**:
```
Timeline item 1: é“å¾‹ 1 è¿å - è¦æ±‚ B-roll ç´ æ ['product.mp4']ï¼Œ
ä½†æœªæä¾›ç´ æåº“ã€‚å¿…é¡»é™çº§ä¸º broll: [] + assumptions
```

### 3. æ ‡å‡†åŒ–

**ä½¿ç”¨æ ‡å‡† JSON Schema**:
- å¯ä»¥ç”¨ä»»ä½• JSON Schema éªŒè¯å™¨
- å¯ä»¥ç”Ÿæˆæ–‡æ¡£
- å¯ä»¥ç”Ÿæˆç±»å‹å®šä¹‰
- è·¨è¯­è¨€å…¼å®¹

### 4. å¯æ‰©å±•

**æ˜“äºæ·»åŠ æ–°çš„éªŒè¯è§„åˆ™**:
```json
{
  "properties": {
    "new_field": {
      "type": "string",
      "pattern": "^[A-Z][0-9]{4}$"
    }
  }
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
cd autocut-director
python test_dsl_schema.py
```

### æµ‹è¯•ç»“æœ

```
======================================================================
ğŸ“Š æµ‹è¯•ç»“æœ
======================================================================
  âœ… æœ‰æ•ˆçš„ DSL
  âœ… ç¼ºå°‘å¿…éœ€å­—æ®µ
  âœ… ç±»å‹é”™è¯¯
  âœ… é“å¾‹ 1 è¿å
  âœ… é“å¾‹ 2 è¿å
  âœ… å®Œæ•´éªŒè¯
  âœ… ç¤ºä¾‹æ–‡ä»¶

é€šè¿‡: 7/7

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

---

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: éªŒè¯ LLM ç”Ÿæˆçš„ DSL

```python
from app.core.llm_engine import LLMDirector
from app.models.dsl_validator import DSLValidator

# ç”Ÿæˆ DSL
director = LLMDirector()
dsl = director.generate_editing_dsl(scenes, transcript, style)

# éªŒè¯
errors = DSLValidator.validate_dsl_against_scenes(
    dsl, scenes_data, broll_library=None
)

if errors:
    print("AI ç”Ÿæˆçš„ DSL æœ‰é”™è¯¯:")
    for err in errors:
        print(f"  - {err}")
    # å¯ä»¥è¦æ±‚ AI é‡æ–°ç”Ÿæˆ
else:
    print("DSL éªŒè¯é€šè¿‡ï¼Œå¯ä»¥æ‰§è¡Œ")
```

### ç¤ºä¾‹ 2: åœ¨ API ä¸­ä½¿ç”¨

```python
@router.post("/api/llm/generate-dsl")
async def generate_dsl(...):
    # ç”Ÿæˆ DSL
    dsl = director.generate_editing_dsl(...)
    
    # éªŒè¯
    errors = DSLValidator.validate_dsl_against_scenes(
        dsl, scenes_data, broll_library=None
    )
    
    if errors:
        return {
            "status": "validation_failed",
            "errors": errors
        }
    
    return {
        "status": "success",
        "dsl": dsl
    }
```

---

## ğŸ”„ å‘åå…¼å®¹

### æ—§ä»£ç æ— éœ€ä¿®æ”¹

```python
# æ—§ä»£ç ä»ç„¶å¯ä»¥å·¥ä½œ
from app.models.schemas import DSLValidator

errors = DSLValidator.validate_dsl_against_scenes(dsl, scenes_data)
```

### æ–°ä»£ç æ¨èä½¿ç”¨

```python
# æ–°ä»£ç æ¨èä½¿ç”¨ç‹¬ç«‹æ¨¡å—
from app.models.dsl_validator import DSLValidator

errors = DSLValidator.validate_dsl_against_scenes(dsl, scenes_data)
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **[IRON_RULES.md](IRON_RULES.md)** - ä¸¤æ¡é“å¾‹è¯¦ç»†è¯´æ˜
- **[PROTOCOL.md](PROTOCOL.md)** - åè®®æ–‡ä»¶è§„èŒƒ
- **[app/models/dsl_schema.json](app/models/dsl_schema.json)** - JSON Schema å®šä¹‰
- **[app/models/dsl_validator.py](app/models/dsl_validator.py)** - éªŒè¯å™¨å®ç°

---

## ğŸ‰ æ€»ç»“

### æ›´æ–°å†…å®¹

1. âœ… æ–°å¢ `dsl_schema.json` - æ ‡å‡† JSON Schema
2. âœ… æ–°å¢ `dsl_validator.py` - ç‹¬ç«‹éªŒè¯å™¨
3. âœ… æ›´æ–° `schemas.py` - å¯¼å…¥æ–°éªŒè¯å™¨
4. âœ… æ–°å¢ `test_dsl_schema.py` - å®Œæ•´æµ‹è¯•

### æ ¸å¿ƒä¼˜åŠ¿

- ğŸ¯ **æ—©æœŸé”™è¯¯æ£€æµ‹** - Schema åœ¨ç¬¬ä¸€å±‚æ•è·é”™è¯¯
- ğŸ“ **æ¸…æ™°é”™è¯¯ä¿¡æ¯** - ç²¾ç¡®å®šä½é—®é¢˜
- ğŸ“ **æ ‡å‡†åŒ–** - ä½¿ç”¨æ ‡å‡† JSON Schema
- ğŸ”§ **å¯æ‰©å±•** - æ˜“äºæ·»åŠ æ–°è§„åˆ™
- âœ… **å‘åå…¼å®¹** - æ—§ä»£ç æ— éœ€ä¿®æ”¹

### æµ‹è¯•ç»“æœ

- âœ… 7/7 æµ‹è¯•é€šè¿‡
- âœ… ç¤ºä¾‹æ–‡ä»¶éªŒè¯é€šè¿‡
- âœ… ä¸¤æ¡é“å¾‹éªŒè¯æ­£å¸¸

**DSL Schema å·²æ›´æ–°å¹¶éªŒè¯é€šè¿‡ï¼** ğŸ¬âœ¨

---

**ç‰ˆæœ¬**: v1.2.0  
**æ›´æ–°æ—¥æœŸ**: 2025-02-05  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•
