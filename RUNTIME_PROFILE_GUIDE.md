# Runtime Profile ç³»ç»Ÿå®Œæ•´æŒ‡å—

**æ—¥æœŸ**: 2026-02-06  
**ç‰ˆæœ¬**: v2.0.0  
**çŠ¶æ€**: âœ… å®Œæ•´å®ç°

---

## ğŸ¯ æ ¸å¿ƒç†å¿µ

è®©ç³»ç»Ÿ"çŸ¥é“è‡ªå·±åœ¨å¹²ä»€ä¹ˆ" - è‡ªæˆ‘æ„ŸçŸ¥ã€è‡ªæˆ‘è§£é‡Šã€è‡ªæˆ‘é€‚åº”

### ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›

1. **è‡ªæˆ‘æ„ŸçŸ¥** - è‡ªåŠ¨æ£€æµ‹ç¡¬ä»¶é…ç½®
2. **è‡ªæˆ‘è§£é‡Š** - å‘Šè¯‰ç”¨æˆ·ä¸ºä»€ä¹ˆè¿™ä¹ˆè¿è¡Œ
3. **è‡ªæˆ‘é€‚åº”** - åŠ¨æ€ç›‘æ§å¹¶è‡ªåŠ¨é™çº§

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RuntimeProfile                        â”‚
â”‚  (å¯åŠ¨æ—¶æ£€æµ‹ï¼Œä¿å­˜åˆ°ç£ç›˜)                                â”‚
â”‚  - CPU / Memory / GPU                                   â”‚
â”‚  - AI Runtime (Ollama)                                  â”‚
â”‚  - Editor (DaVinci Resolve)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ExecutionPolicyResolver                  â”‚
â”‚  (æ ¹æ® Profile ç”Ÿæˆç­–ç•¥)                                 â”‚
â”‚  - Vision Policy                                        â”‚
â”‚  - Planning Policy                                      â”‚
â”‚  - Editing Policy                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RuntimeMonitor                        â”‚
â”‚  (åŠ¨æ€ç›‘æ§ï¼Œè‡ªåŠ¨é™çº§)                                     â”‚
â”‚  - GPU æ˜¾å­˜ä½¿ç”¨ç‡                                        â”‚
â”‚  - å†…å­˜å‹åŠ›                                              â”‚
â”‚  - ä»»åŠ¡å¤±è´¥ç‡                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡å™¨

```bash
cd autocut-director
python run_server.py
```

æœåŠ¡å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ï¼š
1. æ£€æµ‹ç¡¬ä»¶é…ç½®
2. ç”Ÿæˆæ‰§è¡Œç­–ç•¥
3. å¯åŠ¨è¿è¡Œæ—¶ç›‘æ§
4. ä¿å­˜é…ç½®åˆ° `runtime_profile.json`

### 2. æŸ¥çœ‹è¿è¡Œæ—¶çŠ¶æ€

```bash
# è®¿é—® API
curl http://localhost:8000/api/runtime/status
```

æˆ–è®¿é—® Web UIï¼š
```
http://localhost:8000/
```

---

## ğŸ“‹ Profile åˆ†ç±»

ç³»ç»Ÿæ ¹æ®ç¡¬ä»¶è‡ªåŠ¨åˆ†ç±»ä¸º 5 ä¸ªç­‰çº§ï¼š

### 1. LOCAL_GPU_HIGHï¼ˆé«˜ç«¯å·¥ä½œç«™ï¼‰

**ç¡¬ä»¶è¦æ±‚**:
- GPU: RTX 4090 / 3090 (16GB+ æ˜¾å­˜)
- CPU: 16+ çº¿ç¨‹
- å†…å­˜: 32GB+

**è¿è¡Œç­–ç•¥**:
```json
{
  "vision": {
    "provider": "local",
    "model": "llava-phi3",
    "device": "gpu",
    "max_scenes": 20
  },
  "planning": {
    "provider": "local",
    "model": "qwen2.5-14b"
  },
  "editing": {
    "executor": "davinci",
    "parallelism": 1,
    "preview_quality": "high"
  }
}
```

**ç‰¹ç‚¹**: å…¨æœ¬åœ°è¿è¡Œï¼Œé›¶æˆæœ¬ï¼Œæœ€ä½³æ€§èƒ½

---

### 2. LOCAL_GPU_MIDï¼ˆä¸­ç«¯é…ç½®ï¼‰â­ æ¨è

**ç¡¬ä»¶è¦æ±‚**:
- GPU: RTX 4060 / 3060 (8GB æ˜¾å­˜)
- CPU: 12+ çº¿ç¨‹
- å†…å­˜: 16GB+

**è¿è¡Œç­–ç•¥**:
```json
{
  "vision": {
    "provider": "local",
    "model": "moondream",
    "device": "auto",
    "max_scenes": 10
  },
  "planning": {
    "provider": "cloud",
    "model": "deepseek-chat"
  },
  "editing": {
    "executor": "davinci",
    "parallelism": 1,
    "preview_quality": "medium"
  }
}
```

**ç‰¹ç‚¹**: æœ¬åœ°è§†è§‰åˆ†æ + äº‘ç«¯è§„åˆ’ï¼Œå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬

---

### 3. LOCAL_GPU_LOWï¼ˆä½ç«¯é…ç½®ï¼‰

**ç¡¬ä»¶è¦æ±‚**:
- GPU: GTX 1660 / RTX 2060 (4-6GB æ˜¾å­˜)
- CPU: 8+ çº¿ç¨‹
- å†…å­˜: 8GB+

**è¿è¡Œç­–ç•¥**:
```json
{
  "vision": {
    "provider": "local",
    "model": "moondream",
    "device": "cpu",
    "max_scenes": 5
  },
  "planning": {
    "provider": "cloud",
    "model": "deepseek-chat"
  }
}
```

**ç‰¹ç‚¹**: CPU æ¨¡å¼è§†è§‰åˆ†æï¼Œé™åˆ¶åœºæ™¯æ•°

---

### 4. LOCAL_CPU_ONLYï¼ˆæ— ç‹¬æ˜¾ï¼‰

**ç¡¬ä»¶è¦æ±‚**:
- GPU: æ— æˆ–é›†æˆæ˜¾å¡
- CPU: 8+ çº¿ç¨‹
- å†…å­˜: 8GB+

**è¿è¡Œç­–ç•¥**:
```json
{
  "vision": {
    "provider": "cloud",
    "model": "gpt-4o",
    "device": "cpu",
    "max_scenes": 10
  },
  "planning": {
    "provider": "cloud",
    "model": "deepseek-chat"
  }
}
```

**ç‰¹ç‚¹**: å…¨äº‘ç«¯ AI å¤„ç†

---

### 5. CLOUD_HYBRIDï¼ˆæ··åˆæ¨¡å¼ï¼‰

**ç‰¹ç‚¹**: çµæ´»é…ç½®ï¼Œæ ¹æ®éœ€æ±‚é€‰æ‹©æœ¬åœ°/äº‘ç«¯

---

## ğŸ” è¿è¡Œæ—¶ç›‘æ§

### ç›‘æ§æŒ‡æ ‡

RuntimeMonitor æ¯ 5 ç§’æ”¶é›†ä¸€æ¬¡æŒ‡æ ‡ï¼š

1. **GPU æ˜¾å­˜ä½¿ç”¨ç‡** - é˜²æ­¢ OOM
2. **å†…å­˜å¯ç”¨é‡** - é˜²æ­¢ç³»ç»Ÿå¡æ­»
3. **CPU ä½¿ç”¨ç‡** - ç›‘æ§è´Ÿè½½
4. **Resolve çŠ¶æ€** - æ˜¯å¦ç¹å¿™
5. **ä»»åŠ¡å¤±è´¥ç‡** - è´¨é‡ç›‘æ§

### è‡ªåŠ¨é™çº§è§„åˆ™

| è§¦å‘æ¡ä»¶ | é™çº§åŠ¨ä½œ |
|---------|---------|
| GPU æ˜¾å­˜ > 85% | åˆ‡æ¢åˆ° CPU æ¨¡å¼ |
| å¯ç”¨å†…å­˜ < 2GB | åˆ‡æ¢åˆ°äº‘ç«¯ Vision |
| ä»»åŠ¡å¤±è´¥ç‡ > 30% | åˆ‡æ¢åˆ°äº‘ç«¯ Vision |

### é™çº§ç¤ºä¾‹

```
åŸå§‹ç­–ç•¥:
  Vision: local / moondream (GPU)
  Max Scenes: 10

è§¦å‘é™çº§: GPU æ˜¾å­˜ä½¿ç”¨ç‡è¿‡é«˜ (87%)

é™çº§åç­–ç•¥:
  Vision: cloud / gpt-4o (CPU)
  Max Scenes: 5
```

---

## ğŸ› ï¸ API æ¥å£

### 1. è·å– Profile

```bash
GET /api/runtime/profile
```

**å“åº”**:
```json
{
  "profile": {
    "cpu": {"cores": 16, "threads": 24, "score": "high"},
    "memory": {"total_gb": 32, "available_gb": 18},
    "gpu": {
      "vendor": "NVIDIA",
      "model": "RTX 4060",
      "vram_gb": 8,
      "cuda": true
    },
    "ai_runtime": {
      "ollama": true,
      "ollama_models": ["moondream"],
      "cuda_available": true
    },
    "profile_class": "LOCAL_GPU_MID"
  },
  "explanation": "ğŸ§  ç³»ç»Ÿè¿è¡Œæ¨¡å¼\n- æ£€æµ‹åˆ° NVIDIA RTX 4060 (8GB æ˜¾å­˜)\n..."
}
```

### 2. è·å–æ‰§è¡Œç­–ç•¥

```bash
GET /api/runtime/policy
```

**å“åº”**:
```json
{
  "policy": {
    "vision": {
      "provider": "local",
      "model": "moondream",
      "device": "auto",
      "max_scenes": 10
    },
    "planning": {
      "provider": "cloud",
      "model": "deepseek-chat"
    },
    "editing": {
      "executor": "davinci",
      "parallelism": 1,
      "preview_quality": "medium"
    }
  }
}
```

### 3. è·å–ç›‘æ§çŠ¶æ€

```bash
GET /api/runtime/monitor
```

**å“åº”**:
```json
{
  "running": true,
  "degraded": false,
  "metrics": {
    "gpu": {
      "vram_used_percent": 45.2,
      "vram_used_gb": 3.6,
      "vram_total_gb": 8.0
    },
    "memory": {
      "used_percent": 62.5,
      "available_gb": 12.0
    },
    "cpu": {
      "percent": 35.8
    },
    "resolve_busy": false,
    "task_failure_rate": 0.0
  },
  "task_stats": {
    "total": 10,
    "failed": 0,
    "success_rate": 100.0
  }
}
```

### 4. è·å–å®Œæ•´çŠ¶æ€

```bash
GET /api/runtime/status
```

**å“åº”**: åŒ…å« Profile + Policy + Monitor + Recommendations

### 5. æ‰‹åŠ¨é™çº§

```bash
POST /api/runtime/policy/degrade?reason=æµ‹è¯•é™çº§
```

### 6. é‡æ–°æ£€æµ‹

```bash
GET /api/runtime/profile/reload
GET /api/runtime/policy/reload
```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd autocut-director
python test_runtime_profile.py
```

**æµ‹è¯•å†…å®¹**:
1. RuntimeProfile è‡ªåŠ¨æ£€æµ‹
2. ExecutionPolicy ç”Ÿæˆ
3. ç­–ç•¥é™çº§
4. RuntimeMonitor ç›‘æ§
5. ç”¨æˆ·å‹å¥½è§£é‡Š
6. å®Œæ•´é›†æˆæµ‹è¯•

---

## ğŸ“ é…ç½®æ–‡ä»¶

### runtime_profile.json

å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼š

```json
{
  "cpu": {
    "cores": 16,
    "threads": 24,
    "score": "high"
  },
  "memory": {
    "total_gb": 32.0,
    "available_gb": 18.5
  },
  "gpu": {
    "vendor": "NVIDIA",
    "model": "RTX 4060",
    "vram_gb": 8.0,
    "cuda": true
  },
  "ai_runtime": {
    "ollama": true,
    "ollama_models": ["moondream"],
    "cuda_available": true
  },
  "editor": {
    "davinci": {
      "installed": true,
      "version": "20",
      "scriptable": true
    }
  },
  "os": "Windows",
  "profile_class": "LOCAL_GPU_MID",
  "degraded": false,
  "degradation_reason": null
}
```

---

## ğŸ¨ ç”¨æˆ·ç•Œé¢æ˜¾ç¤º

### å¯åŠ¨æ—¶æ˜¾ç¤º

```
============================================================
ğŸš€ AutoCut Director å¯åŠ¨ä¸­...
============================================================

ğŸ“Š æ£€æµ‹è¿è¡Œæ—¶é…ç½®...
âœ“ é…ç½®æ–‡ä»¶å·²ä¿å­˜: runtime_profile.json

ğŸ§  ç³»ç»Ÿè¿è¡Œæ¨¡å¼
- æ£€æµ‹åˆ° NVIDIA RTX 4060 (8.0GB æ˜¾å­˜)
- CPU: 24 çº¿ç¨‹ (high æ€§èƒ½)
- å†…å­˜: 32.0GB (å¯ç”¨ 18.5GB)
- æœ¬åœ° AI: Ollama (1 ä¸ªæ¨¡å‹)

ğŸ“Š è¿è¡Œçº§åˆ«: LOCAL_GPU_MID

ğŸ“‹ ç”Ÿæˆæ‰§è¡Œç­–ç•¥...
âœ“ Vision: local / moondream
âœ“ Planning: cloud / deepseek-chat
âœ“ Editing: davinci

ğŸ” å¯åŠ¨è¿è¡Œæ—¶ç›‘æ§...

============================================================
âœ… AutoCut Director å¯åŠ¨å®Œæˆ
============================================================
```

### é™çº§æ—¶æ˜¾ç¤º

```
âš ï¸  è§¦å‘è‡ªåŠ¨é™çº§: GPU æ˜¾å­˜ä½¿ç”¨ç‡è¿‡é«˜ (87%)

âš ï¸  è‡ªåŠ¨é™çº§è§¦å‘: GPU æ˜¾å­˜ä½¿ç”¨ç‡è¿‡é«˜ (87%)
  â†’ é™çº§å Vision: cloud
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰é™çº§å›è°ƒ

```python
from app.core.runtime_monitor import get_runtime_monitor

monitor = get_runtime_monitor()

def my_callback(reason: str):
    print(f"é™çº§è§¦å‘: {reason}")
    # è‡ªå®šä¹‰å¤„ç†é€»è¾‘

monitor.register_degradation_callback(my_callback)
```

### 2. æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨ CPU

```python
from app.core.runtime_monitor import get_runtime_monitor

monitor = get_runtime_monitor()

if monitor.should_use_cpu_for_vision():
    # ä½¿ç”¨ CPU æ¨¡å¼
    pass
```

### 3. è®°å½•ä»»åŠ¡ç»“æœ

```python
from app.core.runtime_monitor import get_runtime_monitor

monitor = get_runtime_monitor()

try:
    # æ‰§è¡Œä»»åŠ¡
    result = do_something()
    monitor.record_task_result(success=True)
except:
    monitor.record_task_result(success=False)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ORCHESTRATOR_DESIGN.md](ORCHESTRATOR_DESIGN.md) - çŠ¶æ€æœºå’Œè°ƒåº¦ç®—æ³•
- [OLLAMA_INTEGRATION_SUMMARY.md](OLLAMA_INTEGRATION_SUMMARY.md) - æœ¬åœ°è§†è§‰æ¨¡å‹é›†æˆ
- [SYSTEM_ARCHITECTURE_V2.md](SYSTEM_ARCHITECTURE_V2.md) - ç³»ç»Ÿæ¶æ„æ€»è§ˆ

---

## âœ… å®ç°æ¸…å•

- [x] RuntimeProfile è‡ªåŠ¨æ£€æµ‹
- [x] ExecutionPolicyResolver ç­–ç•¥ç”Ÿæˆ
- [x] RuntimeMonitor åŠ¨æ€ç›‘æ§
- [x] è‡ªåŠ¨é™çº§æœºåˆ¶
- [x] API æ¥å£
- [x] å¯åŠ¨æ—¶åˆå§‹åŒ–
- [x] é…ç½®æ–‡ä»¶ä¿å­˜
- [x] ç”¨æˆ·å‹å¥½è§£é‡Š
- [x] å®Œæ•´æµ‹è¯•è„šæœ¬
- [x] æ–‡æ¡£

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼

1. **é›¶é…ç½®** - è‡ªåŠ¨æ£€æµ‹ï¼Œå¼€ç®±å³ç”¨
2. **è‡ªæˆ‘æ„ŸçŸ¥** - çŸ¥é“è‡ªå·±çš„ç¡¬ä»¶èƒ½åŠ›
3. **è‡ªæˆ‘è§£é‡Š** - å‘Šè¯‰ç”¨æˆ·ä¸ºä»€ä¹ˆè¿™ä¹ˆè¿è¡Œ
4. **è‡ªæˆ‘é€‚åº”** - åŠ¨æ€ç›‘æ§ï¼Œè‡ªåŠ¨é™çº§
5. **é˜²å´©æºƒ** - æ°¸è¿œä¸ä¼šå› ä¸ºèµ„æºä¸è¶³è€Œå´©æºƒ

---

**è®©ç³»ç»Ÿ"çŸ¥é“è‡ªå·±åœ¨å¹²ä»€ä¹ˆ"** âœ…
